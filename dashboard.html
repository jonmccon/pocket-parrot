<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Dashboard - Pocket Parrot</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .user-item {
            background: rgba(51, 65, 85, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }
        
        .user-item:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(148, 163, 184, 0.3);
        }
        
        .log-entry {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            border-left: 3px solid transparent;
        }
        
        .log-connect {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        
        .log-disconnect {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }
        
        .log-data {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
        }
        
        .log-error {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-bar {
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%);
            height: 24px;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">üìä Server Dashboard</h1>
            <p class="text-gray-400">Real-time monitoring for Pocket Parrot events</p>
        </div>

        <!-- Connection Status -->
        <div class="mb-6">
            <div class="stat-card text-center">
                <div id="connectionStatus" class="text-lg">
                    <span id="statusIcon">üî¥</span>
                    <span id="statusText">Connecting to server...</span>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Active Users -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">Active Users</div>
                <div class="text-3xl font-bold text-green-400 pulse-animation" id="activeUsers">0</div>
                <div class="text-xs text-gray-500 mt-1">Max: 25</div>
            </div>

            <!-- Total Data Points -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">Total Data Points</div>
                <div class="text-3xl font-bold text-blue-400" id="totalDataPoints">0</div>
                <div class="text-xs text-gray-500 mt-1">Since start</div>
            </div>

            <!-- Data Rate -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">Data Rate</div>
                <div class="text-3xl font-bold text-purple-400" id="dataRate">0</div>
                <div class="text-xs text-gray-500 mt-1">points/min</div>
            </div>

            <!-- Uptime -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">Uptime</div>
                <div class="text-3xl font-bold text-yellow-400" id="uptime">0:00</div>
                <div class="text-xs text-gray-500 mt-1">hh:mm:ss</div>
            </div>
        </div>
        
        <!-- Listeners Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Passive Listeners -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">üìª Passive Listeners</div>
                <div class="text-2xl font-bold text-cyan-400" id="passiveListeners">0</div>
                <div class="text-xs text-gray-500 mt-1">All data</div>
            </div>

            <!-- Orientation Listeners -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">üß≠ Orientation Listeners</div>
                <div class="text-2xl font-bold text-orange-400" id="orientationListeners">0</div>
                <div class="text-xs text-gray-500 mt-1">Low-latency</div>
            </div>

            <!-- Bulk Data Listeners -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">üì¶ Bulk Data Listeners</div>
                <div class="text-2xl font-bold text-emerald-400" id="bulkDataListeners">0</div>
                <div class="text-xs text-gray-500 mt-1">Batched</div>
            </div>

            <!-- Bulk Queue Size -->
            <div class="stat-card">
                <div class="text-gray-400 text-sm mb-1">üìä Bulk Queue</div>
                <div class="text-2xl font-bold text-pink-400" id="bulkQueueSize">0</div>
                <div class="text-xs text-gray-500 mt-1">Pending items</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Active Connections -->
            <div class="stat-card">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                    <span>üë• Active Connections</span>
                    <div class="flex items-center gap-4">
                        <button id="demoteButton" onclick="demoteCurrentSender()" 
                                class="px-3 py-1 text-xs bg-orange-600 hover:bg-orange-700 text-white rounded transition-colors hidden">
                            Demote Active Sender
                        </button>
                        <span class="text-sm font-normal text-gray-400" id="connectionCount">0/25</span>
                    </div>
                </h2>
                <div id="userList" class="max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-center py-8">No active connections</div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="stat-card">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                    <span>üìù Activity Log</span>
                    <button onclick="clearLogs()" class="text-sm font-normal text-red-400 hover:text-red-300">Clear</button>
                </h2>
                <div id="logContainer" class="max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-center py-8">Waiting for activity...</div>
                </div>
            </div>
        </div>

        <!-- Data Throughput Chart -->
        <div class="stat-card mt-6">
            <h2 class="text-xl font-bold mb-4">üìà Data Throughput (Last 10 Minutes)</h2>
            <div id="throughputChart" class="space-y-2">
                <!-- Chart will be populated dynamically -->
            </div>
        </div>

        <!-- Server Configuration -->
        <div class="mt-8 text-center">
            <div class="stat-card inline-block">
                <h3 class="font-semibold mb-2">Server Configuration</h3>
                <div class="text-sm text-gray-400 space-y-1">
                    <div>Dashboard URL: <span class="text-blue-400 font-mono" id="dashboardUrl">ws://localhost:8080/dashboard</span></div>
                    <div>Max Users: <span class="text-green-400">25</span></div>
                    <div>Rate Limiting: <span class="text-green-400">Enabled</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectTimeout = null;
        let logs = [];
        let maxLogs = 100;
        let startTime = Date.now();
        let throughputData = new Array(10).fill(0);
        let throughputIndex = 0;

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const dashboardEndpoint = urlParams.get('server') || 'ws://localhost:8080/dashboard';
        
        document.getElementById('dashboardUrl').textContent = dashboardEndpoint;

        function connect() {
            updateStatus('üü°', 'Connecting...');
            
            try {
                ws = new WebSocket(dashboardEndpoint);
                
                ws.onopen = () => {
                    console.log('‚úÖ Connected to server dashboard');
                    updateStatus('üü¢', 'Connected');
                    clearTimeout(reconnectTimeout);
                    
                    // Request initial stats
                    ws.send(JSON.stringify({ type: 'getStats' }));
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    addLog('error', 'Connection error occurred');
                };
                
                ws.onclose = () => {
                    console.log('‚ùå Disconnected from server');
                    updateStatus('üî¥', 'Disconnected');
                    
                    // Attempt to reconnect after 5 seconds
                    reconnectTimeout = setTimeout(connect, 5000);
                };
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('üî¥', 'Connection failed');
                reconnectTimeout = setTimeout(connect, 5000);
            }
        }

        function updateStatus(icon, text) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusText').textContent = text;
        }

        // User management functions
        function kickUser(userId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server');
                return;
            }
            if (confirm('Are you sure you want to kick this user?')) {
                console.log('Kicking user:', userId);
                ws.send(JSON.stringify({
                    type: 'kickUser',
                    userId: userId
                }));
                // Add immediate feedback since server doesn't send confirmation
                addLog('error', `Kick command sent for user ${userId}`);
            }
        }

        function promoteUser(userId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server');
                return;
            }
            if (confirm('Promote this user to active sender?')) {
                console.log('Promoting user:', userId);
                ws.send(JSON.stringify({
                    type: 'promoteUser',
                    userId: userId
                }));
                // Add immediate feedback - server will send senderPromoted message
                addLog('connect', `Promotion command sent for user ${userId}`);
            }
        }

        function demoteCurrentSender() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to server');
                return;
            }
            if (confirm('Demote the current active sender?')) {
                console.log('Demoting current active sender');
                ws.send(JSON.stringify({
                    type: 'demoteUser'
                }));
                // Add immediate feedback since server doesn't send confirmation
                addLog('disconnect', `Demote command sent for active sender`);
            }
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'stats':
                    updateStats(message.data);
                    break;
                case 'userConnected':
                    addLog('connect', `User ${message.userId} connected from ${message.ip || 'unknown'}`);
                    break;
                case 'userDisconnected':
                    const wasActiveText = message.wasActiveSender ? ' [was active sender]' : '';
                    addLog('disconnect', `User ${message.userId} disconnected (${message.dataCount} points sent)${wasActiveText}`);
                    break;
                case 'dataReceived':
                    addLog('data', `Data from ${message.userId}: point #${message.pointNumber}`);
                    break;
                case 'senderPromoted':
                    const username = message.username || message.userId;
                    addLog('connect', `User ${username} promoted to active sender`);
                    break;
                default:
                    console.log('Unknown message type:', message.type, message);
                    break;
            }
        }

        function updateStats(stats) {
            // Update counters
            document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
            document.getElementById('passiveListeners').textContent = stats.passiveListeners || 0;
            document.getElementById('orientationListeners').textContent = stats.orientationListeners || 0;
            document.getElementById('bulkDataListeners').textContent = stats.bulkDataListeners || 0;
            document.getElementById('bulkQueueSize').textContent = stats.bulkQueueSize || 0;
            document.getElementById('totalDataPoints').textContent = stats.totalDataPoints || 0;
            document.getElementById('dataRate').textContent = (stats.dataRate || 0).toFixed(1);
            document.getElementById('connectionCount').textContent = `${stats.activeUsers || 0}/25`;
            
            // Update uptime
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('uptime').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update user list with controls
            if (stats.users && stats.users.length > 0) {
                // Check if there's an active sender to show/hide demote button
                const hasActiveSender = stats.users.some(user => user.isActiveSender);
                const demoteButton = document.getElementById('demoteButton');
                if (hasActiveSender) {
                    demoteButton.classList.remove('hidden');
                } else {
                    demoteButton.classList.add('hidden');
                }
                
                const userListHtml = stats.users.map(user => {
                    const isActive = user.isActiveSender ? ' [ACTIVE SENDER]' : '';
                    const lastData = user.lastData ? new Date(user.lastData).toLocaleTimeString() : 'Never';
                    
                    return `
                        <div class="user-item">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="font-semibold ${user.isActiveSender ? 'text-yellow-400' : 'text-blue-400'}">
                                        ${user.username || user.id}${isActive}
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1 space-y-1">
                                        <div>Connected: ${formatTime(user.connectedAt)}</div>
                                        <div>Last Data: ${lastData} | Points: ${user.dataCount}</div>
                                        <div>IP: ${user.ip || 'Unknown'} | Device: ${user.deviceId || 'Unknown'}</div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1 ml-4">
                                    ${!user.isActiveSender ? 
                                        `<button onclick="promoteUser('${user.id}')" 
                                                class="px-3 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded transition-colors">
                                            Promote
                                        </button>` : 
                                        ''
                                    }
                                    <button onclick="kickUser('${user.id}')" 
                                            class="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                                        Kick
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('userList').innerHTML = userListHtml;
            } else {
                // Hide demote button when no users
                document.getElementById('demoteButton').classList.add('hidden');
                document.getElementById('userList').innerHTML = 
                    '<div class="text-gray-500 text-center py-8">No active connections</div>';
            }
            
            // Update throughput chart
            if (stats.dataRate !== undefined) {
                throughputData[throughputIndex] = stats.dataRate;
                throughputIndex = (throughputIndex + 1) % throughputData.length;
                updateThroughputChart();
            }
        }

        function updateThroughputChart() {
            const maxValue = Math.max(...throughputData, 1);
            const chartHtml = throughputData.map((value, index) => {
                const percentage = (value / maxValue) * 100;
                const label = ((throughputIndex - throughputData.length + index + throughputData.length) % throughputData.length);
                return `
                    <div class="flex items-center gap-2">
                        <div class="w-12 text-xs text-gray-400">-${throughputData.length - index}m</div>
                        <div class="flex-1 bg-gray-700 rounded">
                            <div class="chart-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="w-16 text-xs text-right text-gray-400">${value.toFixed(1)}/min</div>
                    </div>
                `;
            }).join('');
            document.getElementById('throughputChart').innerHTML = chartHtml;
        }

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ type, message, timestamp });
            
            // Keep only last maxLogs entries
            if (logs.length > maxLogs) {
                logs = logs.slice(0, maxLogs);
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            if (logs.length === 0) {
                document.getElementById('logContainer').innerHTML = 
                    '<div class="text-gray-500 text-center py-8">Waiting for activity...</div>';
                return;
            }
            
            const logHtml = logs.map(log => `
                <div class="log-entry log-${log.type}">
                    <span class="text-gray-500">[${log.timestamp}]</span> ${log.message}
                </div>
            `).join('');
            
            document.getElementById('logContainer').innerHTML = logHtml;
        }

        function clearLogs() {
            logs = [];
            updateLogDisplay();
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        // Update uptime every second
        setInterval(() => {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('uptime').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);

        // Initialize
        connect();
    </script>
</body>
</html>
